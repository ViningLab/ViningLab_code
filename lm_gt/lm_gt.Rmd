---
title: "Linear model"
output: 
  html_document:
    code_folding: hide
    toc: true
date: "2023-05-15"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = "center")
```


```{r}
t1 <- Sys.time()
```


## Linear model building


\begin{equation}
y = \beta_0 + \beta_1 locus_A + \epsilon
\tag{1}
\end{equation}

\begin{equation}
y = \beta_0 + \beta_1 locus_A + \beta_2 locus_B + \epsilon
\tag{2}
\end{equation}

\begin{equation}
y = \beta_0 + \beta_1 locus_A + \beta_2 locus_B + \beta_3 locus_A:locus_B + \epsilon
\tag{3}
\end{equation}


## Phenotypic data

```{r}
pheno <- read.csv("phenotypes.csv")
head(pheno)
```


## Genotypic data


```{r}
library(vcfR)
```


```{r, results='hide'}
vcf <- read.vcfR("varin_Blink.vcf.gz")
```


```{r}
vcf
getFIX( vcf )
```

## Synchronize phenotype and genotype data

```{r}
all( colnames(vcf@gt)[-1] %in% pheno$Taxa)
# pheno[1:3, ]
row.names(pheno) <- pheno$Taxa
pheno <- pheno[colnames(vcf@gt)[-1], ]
all( colnames(vcf@gt)[-1] == pheno$Taxa )
row.names(pheno) <- 1:nrow(pheno)
pheno[1:3, ]
```


```{r}
hist( pheno$Varin_Total, breaks = seq(0, 62, by = 1) )
abline( v = 22.5, lty = 3, col = "#B22222")
```


## Extract genotypes


```{r}
vcf
my_gt <- extract.gt(vcf)
my_gt[ my_gt == "0/0" ] <- 0
my_gt[ my_gt == "0/1" ] <- 1
my_gt[ my_gt == "1/1" ] <- 2
#my_gt <- apply(my_gt, MARGIN = 2, as.numeric)
mode(my_gt) <- "integer"
row.names(my_gt) <- sub("_", ":", row.names(my_gt))
my_gt[1:3, 1:6]
#all(colnames(my_gt) == pheno$Taxa)
```



## Data exploration


```{r, fig.width=10, fig.height=4}
par( mfrow = c(1, 3) )

plot( x = jitter(my_gt["4:36256098", ], factor = 0.4), y = pheno$Varin_Total, xlab = "4:36256098")
abline( h = 22.5, lty = 3, col = "#B22222")

plot( x = jitter(my_gt["4:20005812", ], factor = 0.4), y = pheno$Varin_Total, xlab = "4:20005812")
abline( h = 22.5, lty = 3, col = "#B22222")

plot( x = jitter(my_gt["7:290913", ], factor = 0.4), y = pheno$Varin_Total, xlab = "7:290913")
abline( h = 22.5, lty = 3, col = "#B22222")

par( mfrow = c(1, 1) )
```


## Single locus models


```{r}
# my_loc1 <- "4:68382150"
# my_loc2 <- "7:290913"
my_loc1 <- "4:20005812"
my_loc2 <- "4:21024688"

my_data <- data.frame(
  varin = pheno$Varin_Total,
#  loc1 = my_gt["7:290913", ]
  loc1 = my_gt[my_loc1, ],
  loc2 = my_gt[my_loc2, ]
)
lm1 <- lm(varin ~ loc1, data = my_data)
summary(lm1)

lm2 <- lm(varin ~ loc2, data = my_data)
summary(lm2)

my_df <- data.frame(
  names = c("hom00", "het01", "hom11"),
  means1 = c(mean(my_data$varin[ my_data$loc1 == 0]),
             mean(my_data$varin[ my_data$loc1 == 1]),
             mean(my_data$varin[ my_data$loc1 == 2])
             ),
  means2 = c(mean(my_data$varin[ my_data$loc2 == 0]),
             mean(my_data$varin[ my_data$loc2 == 1]),
             mean(my_data$varin[ my_data$loc2 == 2])
             )
)
#my_df

my_df$est1 <- c(coefficients(lm1)[1],
                1 * coefficients(lm1)[2] + coefficients(lm1)[1],
                2 * coefficients(lm1)[2] + coefficients(lm1)[1]
)
my_df$est2 <- c(coefficients(lm2)[1],
                1 * coefficients(lm2)[2] + coefficients(lm2)[1],
                2 * coefficients(lm2)[2] + coefficients(lm2)[1]
)


#knitr::kable(my_df[, c("names", "means1", "est1", "means2", "est2")])

library(kableExtra)
#color.me <- which(mtcars$cyl >6)
color.me <- c(1, 3)

my_df <- my_df[, c("names", "means1", "est1", "means2", "est2")] 
my_df %>% 
  kable(booktabs = T) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "white", background = "#C0C0C0")

```


```{r}
par( mfrow = c(1, 2) )

plot( x = jitter(my_data$loc1, factor = 0.4), y = my_data$varin, xlab = my_loc1)
abline( h = 22.5, lty = 3, col = "#B22222")
abline(lm1)

plot( x = jitter(my_data$loc2, factor = 0.4), y = my_data$varin, xlab = my_loc2)
abline( h = 22.5, lty = 3, col = "#B22222")
abline(lm2)

par( mfrow = c(1, 1) )
```


## Two locus models


```{r}
lm3 <- lm(varin ~ loc1 + loc2, data = my_data)
summary(lm3)

my_df$loc1_mean <- c(
coefficients(lm3)[1],
1 * coefficients(lm3)[2] + coefficients(lm3)[1],
2 * coefficients(lm3)[2] + coefficients(lm3)[1]
)
my_df$loc2_mean <- c(
  coefficients(lm3)[1],
1 * coefficients(lm3)[3] + coefficients(lm3)[1],
2 * coefficients(lm3)[3] + coefficients(lm3)[1]
)

my_df %>% 
  kable(booktabs = T) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "white", background = "#C0C0C0")
```


```{r}
#par( mfrow = c(1, 1) )

plot( x = jitter(my_data$loc1, factor = 0.4), y = my_data$varin,
      xlab = my_loc1, xlim = c(0, 2.4), pch = 18, col = "#1E90FF")
points( x = jitter(my_data$loc2, factor = 0.4) + 0.2, 
        y = my_data$varin, pch = 17, col = "#228B22")

abline( h = 22.5, lty = 3, col = "#B22222")
#abline( a = coefficients(lm3)[1], b = coefficients(lm3)[2])
#abline( a = coefficients(lm3)[1], b = coefficients(lm3)[3])

abline( a = coefficients(lm3)[1], b = coefficients(lm3)[2] + coefficients(lm3)[3])

#par( mfrow = c(1, 1) )
```


Interaction term


```{r}
lm4 <- lm(varin ~ loc1 + loc2 + loc1:loc2, data = my_data)
summary(lm4)
```



```{r}
#par( mfrow = c(1, 1) )

plot( x = jitter(my_data$loc1, factor = 0.4), y = my_data$varin,
      xlab = my_loc1, xlim = c(0, 2.4), pch = 18, col = "#1E90FF")
points( x = jitter(my_data$loc2, factor = 0.4) + 0.2, 
        y = my_data$varin, pch = 17, col = "#228B22")

abline( h = 22.5, lty = 3, col = "#B22222")
#abline( a = coefficients(lm3)[1], b = coefficients(lm3)[2])
#abline( a = coefficients(lm3)[1], b = coefficients(lm3)[3])

abline( a = coefficients(lm4)[1], b = coefficients(lm4)[2] + coefficients(lm4)[3] + coefficients(lm4)[4])

#par( mfrow = c(1, 1) )
```




```{r}
t99 <- Sys.time()
t99 - t1
```


